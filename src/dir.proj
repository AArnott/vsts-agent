<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <ProjectFile Include="Agent.Listener\Agent.Listener.csproj" />
    <ProjectFile Include="Agent.Service\Windows\AgentService.csproj" />
    <ProjectFile Include="Agent.Worker\Agent.Worker.csproj" />
    <ProjectFile Include="Microsoft.VisualStudio.Services.Agent\Microsoft.VisualStudio.Services.Agent.csproj" />
    <ProjectFile Include="Test\Test.csproj" />
  </ItemGroup>

  <Target Name="Restore">
    <Message Text="-----------------------------------------" Importance="high"/>
    <Message Text="%20%20%20%20%20%20%20%20%20%20%20%20Dotnet Restore" Importance="high"/>
    <Message Text="-----------------------------------------" Importance="high"/>
    <Exec Command="dotnet restore Microsoft.VisualStudio.Services.Agent\Microsoft.VisualStudio.Services.Agent.csproj --runtime $(PackageRuntime)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet restore Agent.Listener\Agent.Listener.csproj --runtime $(PackageRuntime)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet restore Agent.Worker\Agent.Worker.csproj --runtime $(PackageRuntime)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet restore Test\Test.csproj --runtime $(PackageRuntime)" ConsoleToMSBuild="true" />
    <Message Text="-----------------------------------------" Importance="high"/>
    <Message Text="%20%20%20%20%20%20%20%20%20Dotnet Restore Finished" Importance="high"/>
    <Message Text="-----------------------------------------" Importance="high"/>
  </Target>

  <Target Name="GenerateConstant">
    <Exec Command="git rev-parse HEAD" ConsoleToMSBuild="false">
      <Output TaskParameter="ConsoleOutput" PropertyName="GitInfoCommitHash" />
    </Exec>
    <Message Text="Building $(GitInfoCommitHash) --- $(PackageRuntime)" Importance="high"/>

    <ItemGroup>
        <BuildConstants Include="///////////////////////////////////////////////////////////////////////////////////////////////////"/>
        <BuildConstants Include="//"/>
        <BuildConstants Include="//  DO NOT CHECKIN THE GENERATED .cs version of this file"/>
        <BuildConstants Include="//"/>
        <BuildConstants Include="///////////////////////////////////////////////////////////////////////////////////////////////////%0A"/>
        <BuildConstants Include="namespace Microsoft.VisualStudio.Services.Agent"/>
        <BuildConstants Include="{"/>
        <BuildConstants Include="%20%20%20%20public static class BuildConstants"/>
        <BuildConstants Include="%20%20%20%20{"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20public static class Source"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20{"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20%20%20%20%20public static readonly string CommitHash = %22$(GitInfoCommitHash)%22%3B"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20}%0A"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20public static class AgentPackage"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20{"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20%20%20%20%20public static readonly string PackageName = %22$(PackageRuntime)%22%3B"/>
        <BuildConstants Include="%20%20%20%20%20%20%20%20}"/>
        <BuildConstants Include="%20%20%20%20}"/>
        <BuildConstants Include="}"/>
    </ItemGroup>

    <WriteLinesToFile  
            File="Microsoft.VisualStudio.Services.Agent/BuildConstants.cs"
            Lines="@(BuildConstants)"
            Overwrite="true"  
            Encoding="Unicode"/>
  </Target>

  <Target Name="Build" DependsOnTargets="Restore;GenerateConstant">
    <PropertyGroup Condition="'$(PackageRuntime)' == 'win7-x64'" >
        <TargetOS>OS_WINDOWS</TargetOS>
    </PropertyGroup> 
    <PropertyGroup Condition="'$(PackageRuntime)' == 'osx.10.11-x64'" >
        <TargetOS>OS_OSX</TargetOS>
    </PropertyGroup> 
    <PropertyGroup Condition="'$(PackageRuntime)' != 'linux-x64' AND '$(PackageRuntime)' != 'osx.10.11-x64'" >
        <TargetOS>OS_LINUX</TargetOS>
    </PropertyGroup> 
    <Exec Command="dotnet build Microsoft.VisualStudio.Services.Agent\Microsoft.VisualStudio.Services.Agent.csproj -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet build Agent.Listener\Agent.Listener.csproj -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet build Agent.Worker\Agent.Worker.csproj -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet build Test\Test.csproj -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
  </Target>

   <Target Name="Publish" DependsOnTargets="Build">
    <PropertyGroup Condition="'$(PackageRuntime)' == 'win7-x64'" >
        <TargetOS>OS_WINDOWS</TargetOS>
    </PropertyGroup> 
    <PropertyGroup Condition="'$(PackageRuntime)' == 'osx.10.11-x64'" >
        <TargetOS>OS_OSX</TargetOS>
    </PropertyGroup> 
    <PropertyGroup Condition="'$(PackageRuntime)' != 'linux-x64' AND '$(PackageRuntime)' != 'osx.10.11-x64'" >
        <TargetOS>OS_LINUX</TargetOS>
    </PropertyGroup> 
    <Exec Command="dotnet publish Microsoft.VisualStudio.Services.Agent\Microsoft.VisualStudio.Services.Agent.csproj --output %22$(MSBuildProjectDirectory)/../_layout/bin%22 --runtime $(PackageRuntime) -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet publish Agent.Listener\Agent.Listener.csproj --output %22$(MSBuildProjectDirectory)/../_layout/bin%22 --runtime $(PackageRuntime) -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet publish Agent.Worker\Agent.Worker.csproj --output %22$(MSBuildProjectDirectory)/../_layout/bin%22 --runtime $(PackageRuntime) -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
    <Exec Command="dotnet publish Test\Test.csproj --runtime $(PackageRuntime) -c $(BUILDCONFIG) /p:OSConstant=$(TargetOS)" ConsoleToMSBuild="true" />
  </Target>

  <Target Name="CreateLayout" DependsOnTargets="Clean;Publish">
    <ItemGroup>  
        <LayoutRootFiles Include="$(MSBuildProjectDirectory)/Misc/layoutroot/**"/>
        <LayoutBinFiles Include="$(MSBuildProjectDirectory)/Misc/layoutbin/**"/>
    </ItemGroup>  

    <Copy SourceFiles="@(LayoutRootFiles)"  DestinationFolder="$(MSBuildProjectDirectory)/../_layout/%(RecursiveDir)"/>
    <Copy SourceFiles="@(LayoutBinFiles)"  DestinationFolder="$(MSBuildProjectDirectory)/../_layout/bin/%(RecursiveDir)"/>

    <Message Text="-----------------------------------------" Importance="high"/>
    <Message Text="%20%20%20%20%20%20%20%20%20Download Externals" Importance="high"/>
    <Message Text="-----------------------------------------" Importance="high"/> 

    <!--<Exec Command="bash $(MSBuildProjectDirectory)/Misc/externals.sh" ConsoleToMSBuild="True" />-->
  </Target>

  <Target Name="Clean">
    <Message Text="-----------------------------------------" Importance="high"/>
    <Message Text="%20%20%20%20%20%20%20%20%20Clean build outputs" Importance="high"/>
    <Message Text="-----------------------------------------" Importance="high"/> 
    <Exec Command="git clean -fdx -e _dotnetsdk -e _downloads" ConsoleToMSBuild="true" />
  </Target>
</Project>